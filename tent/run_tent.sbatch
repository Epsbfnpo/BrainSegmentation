#!/bin/bash -l
#SBATCH --job-name=tent-adapt
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=32
#SBATCH --mem=128G
#SBATCH --account=OD-210257
#SBATCH --partition=gpu
#SBATCH --gpus-per-node=4
#SBATCH --output=%x-%j.out
#SBATCH --error=%x-%j.err
#SBATCH --time=2:00:00
#SBATCH --signal=B:USR1@120

set -euo pipefail

echo "=============================================================="
echo "TENT ADAPTATION JOB STARTED"
echo "Job $SLURM_JOB_ID started at $(date)"
echo "=============================================================="

# å›ºå®šç»å¯¹è·¯å¾„ï¼Œé¿å…ä¾èµ–æœªçŸ¥ç¯å¢ƒå˜é‡æˆ– Slurm æš‚å­˜ç›®å½•
WORKDIR="/datasets/work/hb-nhmrc-dhcp/work/liu275/tent"
RUN_SCRIPT="${WORKDIR}/run_tent.sh"

export OMP_NUM_THREADS=${SLURM_CPUS_PER_TASK}
export MKL_NUM_THREADS=${SLURM_CPUS_PER_TASK}
export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
export TORCH_ALLOW_TF32=1

cd "${WORKDIR}"

if [ ! -f "${RUN_SCRIPT}" ]; then
    echo "âŒ Missing run script: ${RUN_SCRIPT}"
    echo "Make sure run_tent.sh is present next to run_tent.sbatch on the compute node."
    exit 127
fi

# æ˜ç¡®æŒ‡å®š Conda è·¯å¾„ï¼Œé¿å…ä¾èµ– $HOME ç­‰ç¯å¢ƒå˜é‡
CONDA_SETUP="/datasets/work/hb-nhmrc-dhcp/work/liu275/miniconda3/bin/activate"
if [ -f "${CONDA_SETUP}" ]; then
    source "${CONDA_SETUP}"
    conda activate brainseg || true
fi

RESULTS_DIR="${RESULTS_DIR:-${WORKDIR}/../results/target_tent}"
FINAL_MODEL="${RESULTS_DIR}/best_model.pt"
LATEST_MODEL="${RESULTS_DIR}/latest_model.pt"
SCRIPT_PATH="${WORKDIR}/run_tent.sbatch"

set +e
bash "${RUN_SCRIPT}"
STATUS=$?
set -e

echo "=============================================================="
echo "Job finished with status $STATUS"
echo "=============================================================="

if [ -f "$FINAL_MODEL" ]; then
    echo "ğŸ Training appears complete (found best_model)."
elif [ -f "$LATEST_MODEL" ]; then
    echo "ğŸ” Checkpoint found but training not explicitly marked done. Requeuing..."
    sbatch "$SCRIPT_PATH"
else
    echo "âš ï¸  No checkpoint found. Job failed or first run crashed."
    exit $STATUS
fi

exit $STATUS
